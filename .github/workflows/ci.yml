name: CI Build

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-java:
    name: Build Java (Maven)
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'sapmachine'
        cache: maven
    
    - name: Build with Maven
      run: mvn -B package --file pom.xml -DskipTests
    
    - name: Upload JAR artifacts
      uses: actions/upload-artifact@v4
      with:
        name: java-artifacts
        path: target/*.jar
        retention-days: 7

  build-native:
    name: Build Native Agent
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        include:
          - os: ubuntu-latest
            platform: linux-x64
            lib_ext: so
            lib_prefix: lib
          - os: macos-latest
            platform: macos-arm64
            lib_ext: dylib
            lib_prefix: lib

    runs-on: ${{ matrix.os }}
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'sapmachine'
    
    - name: Test Java Home Detection
      run: |
        cd native
        make test-java-home
    
    - name: Build native agent
      run: |
        cd native
        make
    
    - name: Verify build output
      run: |
        cd native
        ls -la ${{ matrix.lib_prefix }}native_agent.${{ matrix.lib_ext }}
    
    - name: Upload native artifacts
      uses: actions/upload-artifact@v4
      with:
        name: native-${{ matrix.platform }}
        path: native/${{ matrix.lib_prefix }}native_agent.${{ matrix.lib_ext }}
        retention-days: 7

  test-java:
    name: Test Java
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        java-version: ['21', '25']
        include:
          - os: ubuntu-latest
            platform: linux-x64
          - os: macos-latest
            platform: macos-arm64

    runs-on: ${{ matrix.os }}
    needs: build-java
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK ${{ matrix.java-version }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ matrix.java-version }}
        distribution: 'sapmachine'
        cache: maven
    
    - name: Run tests
      run: mvn -B test --file pom.xml
    
    - name: Upload test reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-reports-${{ matrix.platform }}
        path: |
          target/surefire-reports
          target/failsafe-reports
        retention-days: 7

  test-agent-server:
    name: Test Agent Server
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        java-version: ['21', '25']
        include:
          - os: ubuntu-latest
            platform: linux-x64
          - os: macos-latest
            platform: macos-arm64

    runs-on: ${{ matrix.os }}
    needs: build-java

    steps:
    - uses: actions/checkout@v4

    - name: Set up JDK ${{ matrix.java-version }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ matrix.java-version }}
        distribution: 'sapmachine'
        cache: maven

    - name: Build with Maven
      run: mvn -B package --file pom.xml -DskipTests

    - name: Run tests with agent and verify server
      run: |
        # Start Maven tests with agent in background with timeout
        timeout 30 mvn test -DargLine="-javaagent:target/meta-agent.jar=server" &
        TEST_PID=$!
        
        # Wait for server to start
        sleep 20
        
        # Call the server and check for <body> in response
        RESPONSE=$(curl -s http://localhost:7071 || echo "")
        
        # Kill the Maven process if still running
        kill $TEST_PID 2>/dev/null || true
        wait $TEST_PID 2>/dev/null || true
        
        # Verify response contains <body>
        if echo "$RESPONSE" | grep -q "<body>"; then
          echo "✓ Server responded with expected HTML body"
          exit 0
        else
          echo "✗ Server response did not contain <body>"
          echo "Response was: $RESPONSE"
          exit 1
        fi

  build-maven-plugin:
    name: Build Maven Plugin
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'sapmachine'
        cache: maven
    
    - name: Build Maven Plugin
      run: |
        cd maven-plugin
        mvn -B package --file pom.xml -DskipTests
    
    - name: Upload Maven Plugin artifacts
      uses: actions/upload-artifact@v4
      with:
        name: maven-plugin
        path: maven-plugin/target/*.jar
        retention-days: 7

  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [build-java, build-native, test-java, build-maven-plugin, test-agent-server]
    if: always()
    
    steps:
    - name: Check build status
      run: |
        if [ "${{ needs.build-java.result }}" != "success" ]; then
          echo "Java build failed"
          exit 1
        fi
        if [ "${{ needs.build-native.result }}" != "success" ]; then
          echo "Native build failed"
          exit 1
        fi
        if [ "${{ needs.test-java.result }}" != "success" ]; then
          echo "Java tests failed"
          exit 1
        fi
        if [ "${{ needs.build-maven-plugin.result }}" != "success" ]; then
          echo "Maven plugin build failed"
          exit 1
        fi
        if [ "${{ needs.test-agent-server.result }}" != "success" ]; then
          echo "Agent server test failed"
          exit 1
        fi
        echo "All required builds succeeded!"